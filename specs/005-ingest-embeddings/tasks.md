# Tasks: URL Ingestion and Embedding Pipeline

**Input**: Design documents from `specs/005-ingest-embeddings/`
**Prerequisites**: plan.md, spec.md, research.md, data-model.md

## Format: `[ID] [P?] [Story] Description`

- **[P]**: Can run in parallel (different files, no dependencies)
- **[Story]**: Which user story this task belongs to (e.g., US1, US2, US3)
- Include exact file paths in descriptions

## Phase 1: Setup (Shared Infrastructure)

**Purpose**: Project initialization and basic structure.

- [X] T001 Create the `backend/` directory.
- [X] T002 Create the `backend/src/` directory.
- [X] T003 Create an empty file `backend/src/main.py`.
- [X] T004 Create `backend/requirements.txt` with dependencies: `requests`, `beautifulsoup4`, `PyMuPDF`, `cohere`, `qdrant-client`, `python-dotenv`, `langchain`.
- [X] T005 [P] Create a `backend/.env.example` file with `COHERE_API_KEY`, `QDRANT_URL`, and `QDRANT_API_KEY`.

---

## Phase 2: Foundational (Blocking Prerequisites)

**Purpose**: Core infrastructure that MUST be complete before ANY user story can be implemented.

- [X] T006 In `backend/src/main.py`, implement imports, environment variable loading (`dotenv`), and basic argument parsing for a sitemap URL (`--sitemap-url`).
- [X] T007 In `backend/src/main.py`, implement the main orchestration logic in a `main()` function, including placeholder calls for the pipeline steps.

**Checkpoint**: Foundation ready - user story implementation can now begin.

---

## Phase 3: User Story 1 - Ingest Content from URLs (Priority: P1) ðŸŽ¯ MVP

**Goal**: Fetch content from URLs found in the sitemap.

**Independent Test**: The pipeline can download and parse a sitemap, and then download the content from the discovered URLs.

### Implementation for User Story 1

- [X] T008 [US1] In `backend/src/main.py`, implement the `get_all_urls` function to fetch and parse the `sitemap.xml` from the given `--sitemap-url`.
- [X] T009 [US1] In `backend/src/main.py`, implement the `extract_text_from_url` function to handle HTML fetching and basic text extraction using `requests` and `BeautifulSoup4`.
- [X] T010 [US1] In `backend/src/main.py`, enhance `extract_text_from_url` to handle PDF documents using `PyMuPDF`.

**Checkpoint**: At this point, User Story 1 should be fully functional and testable independently.

---

## Phase 4: User Story 2 - Process and Chunk Content (Priority: P2)

**Goal**: Process and chunk the fetched content.

**Independent Test**: Provide sample text to the `chunk_text` function and verify that it is divided into chunks according to the defined strategy.

### Implementation for User Story 2

- [X] T011 [US2] In `backend/src/main.py`, implement the `chunk_text` function using `langchain.text_splitter.RecursiveCharacterTextSplitter`.

**Checkpoint**: At this point, User Stories 1 AND 2 should both work together.

---

## Phase 5: User Story 3 - Generate and Store Embeddings (Priority: P3)

**Goal**: Generate embeddings and store them in Qdrant.

**Independent Test**: A set of sample text chunks can be passed to the embedding and storage functions, which should generate vectors and correctly store them in the vector database.

### Implementation for User Story 3

- [X] T012 [US3] In `backend/src/main.py`, implement `create_collection` to ensure a Qdrant collection named `rag_embedding` exists.
- [X] T013 [US3] In `backend/src/main.py`, implement the `embed` function to generate embeddings using the Cohere client.
- [X] T014 [US3] In `backend/src/main.py`, implement `save_chunk_to_qdrant` to save chunks and their embeddings to Qdrant with deterministic IDs (SHA256 hash of content).

**Checkpoint**: All user stories should now be independently functional and integrated.

---

## Phase 6: Polish & Cross-Cutting Concerns

**Purpose**: Improvements that affect multiple user stories.

- [X] T015 In `backend/src/main.py`, add structured logging (e.g., using the `logging` module) to provide insights into the pipeline's execution.
- [X] T016 In `backend/src/main.py`, implement robust error handling for network requests, API calls, and file processing.
- [X] T017 [P] Create a `backend/README.md` file detailing the setup, configuration, and execution instructions.

---

## Dependencies & Execution Order

- **Setup (Phase 1)** must complete before **Foundational (Phase 2)**.
- **Foundational (Phase 2)** must complete before **User Stories (Phases 3-5)**.
- **User Stories** can be implemented sequentially (US1 â†’ US2 â†’ US3).
- **Polish (Phase 6)** should be done after all user stories are complete.

### User Story Dependencies
- **US1** is the base for all other stories.
- **US2** depends on text content fetched by **US1**.
- **US3** depends on text chunks generated by **US2**.

## Implementation Strategy

### MVP First (User Story 1 Only)

1.  Complete Phase 1: Setup
2.  Complete Phase 2: Foundational
3.  Complete Phase 3: User Story 1
4.  **STOP and VALIDATE**: Test that the pipeline can successfully fetch all content from the sitemap.

### Incremental Delivery

1.  Complete Setup + Foundational.
2.  Add User Story 1 â†’ Test fetching.
3.  Add User Story 2 â†’ Test chunking.
4.  Add User Story 3 â†’ Test embedding and storage.
5.  Complete Polish phase.
